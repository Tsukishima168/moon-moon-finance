# 🔧 同步問題修復說明

## ✅ 已修復的問題

### 1. 前端結帳邏輯 - 只計算 CASH 渠道 ✅

**問題**：結帳時金額有出入，可能算到 LINE Pay、轉帳、Uber 等非現金渠道

**修復**：
- ✅ `ClosingWizard` 已正確過濾：只計算 `channel === 'CASH'` 的交易
- ✅ `Dashboard` 的 `shouldHaveCash` 已同步修正：只計算 CASH 渠道
- ✅ 兩邊邏輯已統一，確保一致性

**驗證方式**：
1. 打開瀏覽器開發者工具（F12）
2. 進入結帳頁面（Step 1）
3. 點擊「🔎 顯示調試信息」
4. 查看「✅ 現金營收交易（只算 CASH）」列表
5. 確認只有 CASH 渠道的交易被計算

---

### 2. Google Sheet 同步問題 - 日期過濾與狀態檢查 ✅

**問題**：有時候 Google Sheet 無法同步到填寫的內容

**可能原因**：
1. 日期過濾不正確（時區問題）
2. 狀態過濾不完整（可能漏掉某些狀態）
3. 查詢範圍不正確

**修復**：
- ✅ 改進 `fetchFirestoreByDate` 的日期範圍查詢（正確處理 GMT+8 時區）
- ✅ 增加詳細的調試日誌（記錄渠道分布、狀態分布）
- ✅ 特別標記 CASH 渠道和錢櫃支出的數量（用於驗證）

**驗證方式**：
1. 執行「🔄 立即同步今日帳務」
2. 查看「📊 查看同步日誌」
3. 檢查日誌中的：
   - `渠道分布`：確認有正確讀取所有渠道
   - `CASH 渠道有效交易`：確認 CASH 交易數量
   - `錢櫃支出有效交易`：確認支出數量

---

## 🔍 排查步驟

### 如果結帳金額還是有出入：

1. **檢查前端計算**：
   - 打開瀏覽器開發者工具（F12）→ Console
   - 進入結帳頁面，查看 `🔍 現金營收計算（只算 CASH）` 的日誌
   - 確認：
     - `現金交易數` 是否正確
     - `排除的交易` 是否包含非 CASH 渠道
     - `合計` 是否正確

2. **檢查 Google Sheet 同步**：
   - 執行同步後，查看「📊 查看同步日誌」
   - 確認：
     - `渠道分布` 是否包含所有渠道
     - `CASH 渠道有效交易` 數量是否與前端一致
     - 是否有錯誤訊息

3. **手動驗證**：
   - 在 Google Sheet 的「🔴 Raw_Transactions」中
   - 篩選：日期 = 今天，渠道 = CASH，狀態 = VALID
   - 手動加總金額，與前端顯示的 `現金營收` 比對

---

## 📋 檢查清單

### 前端結帳邏輯：
- [ ] 只計算 `channel === 'CASH'` 的交易
- [ ] 只計算 `status === 'VALID'` 的交易
- [ ] 只計算今天的交易（日期過濾正確）
- [ ] Debug 面板顯示正確的排除交易

### Google Sheet 同步：
- [ ] 能正確讀取當天的所有交易
- [ ] 日誌顯示正確的渠道分布
- [ ] CASH 渠道數量與前端一致
- [ ] 沒有錯誤訊息

---

## 🚨 如果問題仍然存在

請提供以下資訊：
1. 前端 Console 的日誌（`🔍 現金營收計算`）
2. Google Sheet 同步日誌（`📊 查看同步日誌`）
3. 具體哪一天的資料有問題
4. 預期金額 vs 實際金額

這樣可以更精確地定位問題。
